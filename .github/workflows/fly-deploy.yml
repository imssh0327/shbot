name: Deploy to Fly (main only)

on:
  push:
    branches:
      - main

concurrency:
  group: fly-deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) 소스 코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      # 2) 커밋 SHA 기록 (CD 확인용)
      - name: Write VERSION
        run: echo "${GITHUB_SHA}" > VERSION

      # 3) flyctl 설치
      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      # 4) Fly 배포
      - name: Fly deploy
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy --ha=false